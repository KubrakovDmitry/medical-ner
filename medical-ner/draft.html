<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Модель NER</title>
        <link rel="stylesheet" href="/static/styles.css">
        <style>
            .disabled {
                opacity: 0.6;
                pointer-events: none;
            }
            .button-loading {
                position: relative;
                color: transparent;
            }
            .button-loading::after {
                content: "";
                position: absolute;
                width: 20px;
                height: 20px;
                top: 50%;
                left: 50%;
                margin-left: -10px;
                margin-top: -10px;
                border: 2px solid #ffffff;
                border-radius: 50%;
                border-top-color: transparent;
                animation: spin 1s ease-in-out infinite;
            }
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            #cancel_btn {
                background-color: #dc3545;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                margin-left: 10px;
            }
            #cancel_btn:hover {
                background-color: #c82333;
            }
            #cancel_btn:disabled {
                background-color: #6c757d;
                cursor: not-allowed;
            }
        </style>
    </head>
    <body>
        <h2>Обучение модели NER</h2>
        <form id="ner_form" name="ner_form">
            <label for="model_name">Модель: </label>
            <select name="model_name" id="model_name">
                <option value="DeepPavlov/rubert-base-cased">rubert</option>
                <option value="alexyalunin/RuBioBERT">RuBioBERT</option>
            </select>
            <br/>
            <label for="dataset">Датасет для обучения: </label>
            <input type="file" accept="json" id="dataset" name="dataset">
            <br/>
            <label for="epochs">Укажите число эпох: </label>
            <input type="number" name="epochs" id="epochs" value="3" min="1" max="50"/>
            <br/>
            <label for="train_batch_size">Размер обучающих пакетов</label>
            <input type="number" name="train_batch_size" id="train_batch_size" value="4" min="1" max="1024"/>
            <br/>
            <label for="eval_batch_size">Размер валидирующих пакетов</label>
            <input type="number" name="eval_batch_size" id="eval_batch_size" value="4" min="1" max="1024"/>
            <br/>
            <label for="learning_rate">Скорость обучения</label>
            <input type="number" name="learning_rate" id="learning_rate" step="any" value="1.5e-5" min="1e-10" max="1"/>
            <br/>
            <label for="decay">Скорость затухания скорости обучения</label>
            <input type="number" name="decay" id="decay" step="0.01" value="0.01" min="0.0" max="1.0"/>
            <br/>
            <label for="log">Частота логирования</label>
            <input type="number" name="log" id="log" value="30" min="1" max="1000"/>
            <br/>
            <label for="lr_type">Тип обучения</label>
            <select name="lr_type" id="lr_type">
                <option value="">ничего</option>
                <option value="linear">линейное</option>
                <option value="cosine_with_restarts">косинусоидальное с периодическими перезапусками</option>
                <option value="exponential">экспоненциальное затухание</option>
                <option value="polynomial">полиномиальное затухание</option>
                <option value="step">падение через равные промежутки (ступеньками)</option>
                <option value="multistep">падение в заданные шаги</option>
                <option value="constant">без изменений</option>
                <option value="cosine_annealing_warm_restarts">косинусоидальное с «разогревом» перед каждым циклом</option>
                <option value="onecycle">сначала lr растёт, потом падает (очень эффективный метод)</option>
                <option value="warmup_linear">линейное с разогрев</option>
                <option value="warmup_cosine">косинусоидальное с разогрев</option>
                <option value="warmup_constant">без изменений с разогрев</option>
            </select>
            <br/>
            <label for="warmup_radio">доля для разогрева</label>
            <input type="number" name="warmup_radio" id="warmup_radio" step="0.01" value="0.05" min="0.0" max="1.0"/>
            <br/>
            <label for="fp16">Обучение с понижением точности (FP16)</label>
            <input type="checkbox" name="fp16" id="fp16" value="True"/>
            <br/>
            <label for="grad_accum">Накопление градиента перед обновлением весов моделей</label>
            <input type="number" name="grad_accum" id="grad_accum" min="0" max="1000" value="2"/>
            <br/>
            <div class="form-buttons">
                <button type="submit" id="submit_btn">Обучить</button>
                <button type="reset">Отменить</button>
                <button type="button" id="cancel_btn" style="display: none;">Прервать обучение</button>
            </div>
        </form>
        <div class="centered-container">
            <div id="output_container" name="output_container">
                <textarea id="result_area" name="result_area" readonly></textarea>
            </div>
            <div id="metrics_container" style="margin-top: 20px;">
                <h3>Результаты обучения:</h3>
                <ul id="metrics_list"></ul>
            </div>
        </div>
        <script>
            let isTraining = false;
            let abortController = null;

            function setFormState(disabled) {
                const form = document.getElementById("ner_form");
                const inputs = form.querySelectorAll('input, select, button[type="submit"]');
                const cancelBtn = document.getElementById("cancel_btn");
                const submitBtn = document.getElementById("submit_btn");

                if (disabled) {
                    form.classList.add('disabled');
                    cancelBtn.style.display = 'inline-block';
                    submitBtn.classList.add('button-loading');
                    submitBtn.disabled = true;
                } else {
                    form.classList.remove('disabled');
                    cancelBtn.style.display = 'none';
                    submitBtn.classList.remove('button-loading');
                    submitBtn.disabled = false;
                }
                
                isTraining = disabled;
            }

            async function trainModel(event) {
                event.preventDefault();
                
                if (isTraining) {
                    alert('Обучение уже запущено!');
                    return;
                }

                const resultArea = document.getElementById("result_area")
                const metricsList = document.getElementById("metrics_list")

                resultArea.value = ''
                metricsList.innerHTML = ''

                // Создаем контроллер для возможности прерывания
                abortController = new AbortController();
                
                try {
                    setFormState(true);
                    resultArea.value = "Обучение запущено, подождите...\n";

                    const response = await fetch("/train-ner-model", {
                        method: "POST",
                        body: new FormData(event.target),
                        signal: abortController.signal
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Ошибка HTTP: ${response.status}`);
                    }

                    const result = await response.json();
                    resultArea.value += "\n" + (result.message || "Обучение завершено успешно!");

                    if (result.metrics) {
                        const { precision, recall, f1, loss } = result.metrics;
                        metricsList.innerHTML = `
                            <li><b>Precision: </b>${precision?.toFixed(3) ?? '-'}</li>
                            <li><b>Recall: </b>${recall?.toFixed(3) ?? '-'}</li>
                            <li><b>F1: </b>${f1?.toFixed(3) ?? '-'}</li>
                            <li><b>Loss: </b>${loss?.toFixed(3) ?? '-'}</li>
                        `;
                    }
                }
                catch (error) {
                    if (error.name === 'AbortError') {
                        resultArea.value += "\nОбучение прервано пользователем.";
                    } else {
                        resultArea.value += "\nПри обучении модели возникла ошибка!";
                        console.log(error);
                    }
                }
                finally {
                    setFormState(false);
                    abortController = null;
                }
            }

            function cancelTraining() {
                if (abortController && isTraining) {
                    abortController.abort();
                    setFormState(false);
                }
            }

            // Инициализация событий
            document.getElementById("ner_form").addEventListener("submit", trainModel);
            document.getElementById("cancel_btn").addEventListener("click", cancelTraining);

            // Дополнительная защита - блокировка повторной отправки
            document.getElementById("ner_form").addEventListener("submit", function() {
                if (isTraining) {
                    event.preventDefault();
                    return false;
                }
            });
        </script>
    </body>
</html>