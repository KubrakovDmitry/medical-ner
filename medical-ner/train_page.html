<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Модель NER</title>
        <link rel="stylesheet" href="/static/styles.css">
    </head>
    <body>
        <h2>Обучение модели NER</h2>
        <form id="ner_form" name="ner_form" class="train_form">
            <label for="model_name">Модель: </label>
            <select name="model_name" id="model_name">
                <option value="DeepPavlov/rubert-base-cased">rubert</option>
                <option value="alexyalunin/RuBioBERT">RuBioBERT</option>
            </select>
            <br/>
            <label for="dataset">Датасет для обучения: </label>
            <input type="file" accept="json" id="dataset" name="dataset">
            <br/>
            <label for="epochs">Укажите числе: </label>
            <input type="number" name="epochs" id="epochs" value="3" min="1" max="50"/>
            <br/>
            <label for="train_batch_size">Размер обучающих пакетов</label>
            <input type="number" name="train_batch_size" id="train_batch_size" value="4" min="1" max="1024"/>
            <br/>
            <label for="eval_batch_size">Размер валидирующих пакетов</label>
            <input type="number" name="eval_batch_size" id="eval_batch_size" value="4" min="1" max="1024"/>
            <br/>
            <label for="learning_rate">Скорость обучения</label>
            <input type="number" name="learning_rate" id="learning_rate" step="any" value="1.5e-5" min="1e-10" max="1"/>
            <br/>
            <label for="decay">Скорость затухания скорости обучения</label>
            <input type="number" name="decay" id="decay" step="0.01" value="0.01" min="0.0" max="1.0"/>
            <br/>
            <label for="log">Частота логирования</label>
            <input type="number" name="log" id="log" value="30" min="1" max="1000"/>
            <br/>
            <label for="lr_type">Тип обучения</label>
            <select name="lr_type" id="lr_type">
                <option value="">ничего</option>
                <option value="linear">линейное</option>
                <option value="cosine_with_restarts">косинусоидальное с периодическими перезапусками</option>
                <option value="exponential">экспоненциальное затухание</option>
                <option value="polynomial">полиномиальное затухание</option>
                <option value="step">падение через равные промежутки (ступеньками)</option>
                <option value="multistep">падение в заданные шаги</option>
                <option value="constant">без изменений</option>
                <option value="cosine_annealing_warm_restarts">косинусоидальное с «разогревом» перед каждым циклом</option>
                <option value="onecycle">сначала lr растёт, потом падает (очень эффективный метод)</option>
                <option value="warmup_linear">линейное с разогрев</option>
                <option value="warmup_cosine">косинусоидальное с разогрев</option>
                <option value="warmup_constant">без изменений с разогрев</option>
            </select>
            <br/>
            <label for="warmup_radio">доля для разогрева</label>
            <input type="number" name="warmup_radio" id="warmup_radio" step="0.01" value="0.05" min="0.0" max="1.0"/>
            <br/>
            <label for="fp16">Обучение с понижением точности (FP16)</label>
            <input type="checkbox" name="fp16" id="fp16" value="True"/>
            <br/>
            <label for="grad_accum">Накопление градиента перед обновлением весов моделей</label>
            <input type="number" name="grad_accum" id="grad_accum" min="0" max="1000" value="2"/>
            <br/>
            <input name="submit" type="submit" value="Обучить"/>
            <input name="cancel" type="reset" value="Отменить"/>
            <input name="interrupt_training" type="button" value="Прервать обучение"/>
        </form>
        <div class="centered-container">
            <div id="progress_bar_container">
                <div id="progress_bar"></div>
            </div>
            <div id="output_container" name="output_container">
                <textarea id="result_area" name="result_area" readonly></textarea>
            </div>
            <div id="metrics_container" style="margin-top: 20px;">
                <h3>Результаты обучения:</h3>
                <ul id="metrics_list"></ul>
            </div>
        </div>
        <script>
            let trainingInProgress = false;
            let progressInterval;

            async function trainModel(event) {
                event.preventDefault();

                if (trainingInProgress) {
                    alert("Обучение уже запущено!");
                }

                const resultArea = document.getElementById("result_area");
                const metricsList = document.getElementById("metrics_list");

                resultArea.value = '';
                metricsList.textContent = '';

                try {
                    trainingInProgress = true;
                    resultArea.value = "Обучение запущено, подождите..."

                    startProgressPolling();

                    const response = await fetch("/train-ner-model", {
                            method: "POST",
                            body: new FormData(event.target)
                        });

                    if (!response.ok) {
                        throw new Error(`Ошибка HTTP: ${response.status}`);
                    }

                    const result = await response.json();

                    stopProgressPolling();

                    resultArea.value += "\n" + (result.message || "Обучение завершено успешно!");

                    if (result.metrics) {
                        const { precision, recall, f1, loss } = result.metrics;
                        metricsList.innerHTML = `
                            <li><b>Precision: </b>${precision?.toFixed(3) ?? '-'}</li>
                            <li><b>Recall: </b>${recall?.toFixed(3) ?? '-'}</li>
                            <li><b>F1: </b>${f1?.toFixed(3) ?? '-'}</li>
                            <li><b>Loss: </b>${loss?.toFixed(3) ?? '-'}</li>
                        `;
                    }
                }
                catch (error) {
                    stopProgressPolling();
                    resultArea.value = "При обучении модели возникла ошибка!";
                    console.log(error);
                }
                finally {
                    trainingInProgress = false;
                }
            }

            function startProgressPolling() {
                console.log("Запуск опроса прогресса...");
                progressInterval = setInterval(async () => {
                    try {
                        const response = await fetch("/training-progress");
                        if (response.ok) {
                            const progress = await response.json();
                            console.log("Прогресс получен:", progress);
                            updateProgressDisplay(progress);
                        } else {
                            console.error("Ошибка HTTP:", response.status);
                        }
                    } catch (error) {
                        console.error("Ошибка при запросе прогресса:", error);
                    }
                }, 1000);
            }

            function stopProgressPolling() {
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
            }

            function updateProgressDisplay(progress) {
                const resultArea = document.getElementById("result_area");

                console.log("Получен прогресс:", progress);

                const bar = document.getElementById("progress_bar");
                if (progress.progress !== undefined) {
                    bar.style.width = Math.round(progress.progress * 100) + "%";
                }

                if (progress.status === "preparing") {
                    resultArea.value = "Подготовка данных и модели...\n";
                } else if (progress.status === 'training') {
                    let progressText = `Обучение запущено...\n`;
                    progressText += `Эпоха: ${progress.current_epoch}/${progress.total_epochs}\n`;
                    progressText += `Шаг: ${progress.current_step}/${progress.total_steps}\n`;
                    progressText += `Прогресс: ${Math.round(progress.progress * 100)}%\n`;
                    progressText += `Потери: ${progress.loss !== null ? progress.loss.toFixed(4): 'вычисляется...'}`

                    if (progress.current_metrics) {
                        const metrics = progress.current_metrics;
                        progressText += `Текущие метрики - Precision: ${metrics.precision?.toFixed(3) ?? '-'}, `;
                        progressText += `Recall: ${metrics.recall?.toFixed(3) ?? '-'}, `;
                        progressText += `F1: ${metrics.f1?.toFixed(3) ?? '-'}\n`;
                    }

                    resultArea.value = progressText;
                } else if (progress.status === "completed") {
                    resultArea.value = "Обучение завершено! Обработка результатов...\n";
                } else if (progress.status === 'not_started') {
                    resultArea.value = "Подготовка к обучению...\n";
                }
            }

            document.getElementById("ner_form").addEventListener("submit", trainModel);

            document.querySelector('input[name="interrupt_training"]').addEventListener('click', async function () {
                if (trainingInProgress) {
                    try {
                        await fetch("/interrupt-training", {method: "POST"});
                        stopProgressPolling();
                        trainingInProgress = false;
                        document.getElementById("result_area").value += "\n\nОбучение прервано пользователем";
                    } catch (error) {
                        console.error("Ошибка при прерывании обучения:", error);
                    }
                }
            });
        </script>
    </body>
</html>